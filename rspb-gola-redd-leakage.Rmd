---
title: 'Leakage Belt Delineation'
description: |
  VM0048-compliant delineation of valid leakage area for the Gola REDD+ Forest Carbon Project, Liberia
author:
  - name: Seamus Murphy 
    url: mailto:Seamus.Murphy@winrock.org
    affiliation: Winrock International
    affiliation_url: https://winrock.org/
    orcid_id: 0000-0002-1792-0351
  - name: Krysla Lima Fernandes 
    url: mailto:Krysla.Lima@winrock.org
    affiliation: Winrock International
    affiliation_url: https://winrock.org/
  - name: Rajesh Bista
    url: mailto:Rajesh.Bista@winrock.org
    affiliation: Winrock International
    affiliation_url: https://winrock.org/
  - name: Meyru Bhanti 
    url: mailto:Meyru.Bhanti@winrock.org
    affiliation: Winrock International
    affiliation_url: https://winrock.org/            
date: "`r Sys.Date()`"
output:
  distill::distill_article:
    toc: true
    toc_depth: 6
    toc_float: true
    css: styles.css
    self_contained: true
    highlight: kate
    
editor_options:
  markdown:
    wrap: 80
---

```{r, echo=F, message=F, warning=F, error=F, comment=NA}
readRenviron("~/.Renviron")
#styling notes - theme list
#bootstrap, cerulean, cosmo, darkly, flatly, journal, lumen, paper, readable, sandstone, simplex, spacelab, united, and yeti

library(cols4all)
library(distill)
library(dplyr)
library(flextable)
library(knitr)
library(latex2exp)
library(leaflet)
library(leaflet.extras)
library(leaflet.providers)
library(leafgl)
library(leafem)
library(latticeExtra)
library(maptiles)
library(markdowntemplates)
library(palmerpenguins)
library(raster)
library(Rcpp)
library(RcppThread)
library(rmarkdown)
library(sf)
library(sp)
library(terra)
library(tidyterra)
library(tinytex)
library(tmap)
library(tmaptools)
library(xaringan)
library(xaringanExtra)

base::options(
  htmltools.dir.version = F, 
  htmltools.preserve.raw = F,
  repos = c(CRAN = "https://cloud.r-project.org")
  )

knitr::opts_chunk$set(
  echo    = TRUE, 
  message = FALSE, 
  warning = FALSE,
  error   = FALSE, 
  comment = NA,
  fig.width  = 12,
  fig.height = 8
  )

sf::sf_use_s2(use_s2 = FALSE) # non-spherical/ellipsoid geometries
terraOptions(memfrac=0.9, tempdir = "./temp")
```

<!-- TOC HTML ELEMENTS -->

<input type="button" class="d-article-with-toc" id="TOC" value="&#x2630" title="Toggle (Hide/Show) Table of Contents" alt="Toggle button for hiding/showing the Table of Contents" onclick="toggle()" style="padding:7px; border: 0px;"/>

```{css, echo=FALSE, class.source = 'foldable'}
div.column {
    display: inline-block;
    vertical-align: top;
    width: 80%;
}

#TOC::before {
  content: "";
  display: block;
  height: 60px;
  width: 200px;
  background-image: url(https://winrock.org/wp-content/uploads/2021/12/Winrock-logo-R.png);
  background-size: contain;
  background-position: centre;
  padding-top: 50px !important;
  background-repeat: no-repeat;
}
```

## Objective:

designed to support the project's alignment with Verra’s VM0048 and VMD0055
methodologies.[^1] Specifically, the current workflow systematically documents
the methodological framework, key spatial data inputs, processing steps, and
resulting geospatial estimates involved in delineating a VM0048-compliant
leakage belt around the proposed project boundary.

[^1]:
    -   <https://verra.org/wp-content/uploads/2023/11/VM0048-Reducing-Emissions-from-Deforestation-and-Forest-Degradation-v1.0-1-1.pdf>
    -   <https://verra.org/wp-content/uploads/2024/10/VMD0055-Estimation-of-Emission-Reductions-from-Avoiding-Unplanned-Deforestation-v1.1-CLEAN-2024.10.21.24.pdf>

A recent expansion of the project's proposed area necessitated the
quantification of potential zones where deforestation and forest degradation
pressures might be displaced due to strengthened conservation enforcement and
resource protection within the project area. Accordingly, this report documents
the delineation of a leakage belt from surrounding forestland that meets a set
of eligibility criteria as defined in VM0048 and VMD0055 guidelines. These
criteria explicitly incorporate topographical constraints such as slope
gradients; existing anthropogenic infrastructure, including the proximity and
influence of roads and population centers; and ecological habitat
considerations, specifically the exclusion of protected areas and wetland
ecosystems.

These tasks collectively support the ultimate goal of monitoring and mitigating
leakage risks in unplanned deforestation REDD+ projects, ensuring the integrity
of reported emission reductions and compliance with Verra’s methodological
requirements.

### Project Boundaries

1.  Data imports:

    -   Imported the Liberia national boundary and county shapefiles.[^2]
    -   Filtered counties to select the Grand Cape Mount and Gharpolu
        jurisdictions, relevant for the REDD+ project area.

2.  Data processing:

    -   Assigned a project-level geospatial projection to the EPSG:32629[^3]
        coordinate reference system. This is done as good practice to encourage
        alignment with upstream workflows, thereby limiting horizontal shifts
        typical affect shapefiles at this scale. A project CRS was also declared
        to avoid function errors downstream, as packages tend to handle UTM
        projected coordinates.
    -   Once loaded and reprojected, we scanned for labelling issues, geospatial
        artefacts, polygonal holes, structural or linework violations. In total,
        we identifed 49 topological errors which mostly included overlapping
        junctions and floating islands beneath the shapefile's internal
        coverage.

3.  Area Calculation:

    -   Computed total hectares of project sites.
    -   Final area estimates were reported below which yielded a total project
        footprint of 769,050 ha in the newest expansion (Table 1)

[^2]: Please consult chunk text to confirm data sources, otherwise outlined in
    this markdown's report content

[^3]: <https://epsg.io/32629>

```{r, echo=T, message=F, warning=F, error=F, comment=NA, eval=T}
country = sf::read_sf("./data/AOI/liberia_boundary_national.shp") |>sf::st_transform(32629)
counties = sf::st_read("./data/AOI/places_poly_county.shp") |>sf::st_transform(32629)
jurisdiction = counties |>dplyr::filter(name=="Grand Cape Mount County"|name=="Gharpolu County")
jurisdiction$name = 'Grand Cape Mount & Gharpolu Counties'
pop = sf::st_read("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/POP/Archive/Villages-Extended-Metric.gpkg") |> sf::st_make_valid() |> sf::st_cast("MULTIPOINT")

aoi = sf::read_sf("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/AOI/Archive/ProjectArea_CF-Expansion_051525/updated_areas.shp") |>
  sf::st_make_valid() |>
  sf::st_transform("EPSG:32629") |>  
  sf::st_cast("MULTIPOLYGON") |> sf::st_as_sf()# |> dplyr::select("Name")

aoi$area_ha = round(as.numeric(sf::st_area(aoi) * 0.0001, 4))
aoi |> sf::st_drop_geometry() |> janitor::adorn_totals() |> 
  flextable::flextable() |> 
  flextable::fontsize(size=8,part="all") |> 
  flextable::autofit() 

# check for hidden artefacts
st_geometry_type(aoi)
aoi_valid <- st_make_valid(aoi)
aoi_intersections <- st_intersection(aoi_valid)
aoi_intersections$area_ha <- round(as.numeric(st_area(aoi_intersections) * 0.0001), 3)
artefacts <- aoi_intersections %>% filter(area_ha < 100) |> dplyr::select(-origins)

# process artefacts 
table(sf::st_geometry_type(artefacts))
artefacts_points <- artefacts %>% filter(st_geometry_type(.) %in% c("POINT", "MULTIPOINT"))
artefacts_lines <- artefacts %>% filter(st_geometry_type(.) %in% c("LINESTRING", "MULTILINESTRING"))
artefacts_polygons <- artefacts %>% filter(st_geometry_type(.) %in% c("POLYGON", "MULTIPOLYGON"))
st_write(artefacts_points, "./data/AOI/Archive/artefact_check_points.shp", append=F)
st_write(artefacts_lines, "./data/AOI/Archive/artefact_check_lines.shp", append=F)
st_write(artefacts_polygons, "./data/AOI/Archive/artefact_check_polygons.shp", append=F)

cat("Points:", nrow(artefacts_points), "\n")
cat("Lines:", nrow(artefacts_lines), "\n")
cat("Polygons:", nrow(artefacts_polygons), "\n")

tmap::tmap_mode("view")
tmap::tm_shape(aoi) + tmap::tm_borders(lwd=0.5, col="white") +
  tmap::tm_text(text="Name", size=0.5, col="white") +  
  tmap::tm_shape(country) + tmap::tm_borders(lwd=0.8, col="orange") +
  tmap::tm_shape(counties) + tmap::tm_borders(lwd=1, col="brown") +
  tmap::tm_text(text="name", size=0.8, col="brown") +
  tmap::tm_scalebar(position = c("RIGHT", "BOTTOM"), text.size = .5) + 
  tmap::tm_compass(color.dark = "gray60", text.color = "gray60", position = c("left", "top")) +
  tmap::tm_basemap("Esri.WorldImagery") +
  tmap::tm_view(set_zoom_limits = c(8,14))

```

### Derive Leakage Belt

Implemented per
[VM0048](https://verra.org/wp-content/uploads/2023/11/VM0048-Reducing-Emissions-from-Deforestation-and-Forest-Degradation-v1.0-1-1.pdf)
and
[VMD0055](https://verra.org/wp-content/uploads/2024/10/VMD0055-Estimation-of-Emission-Reductions-from-Avoiding-Unplanned-Deforestation-v1.1-CLEAN-2024.10.21.24.pdf)
methodologies requiring a defined buffer around the project area to monitor
potential leakage.

*Implementation steps:*

1.  Leakage belt radius:
    -   Created an initial 5.5 km buffer around the AOI, converted to polygon,
        and validated geometry.
    -   Generated a second buffer extending an additional 4.5 km, creating a 10
        km total radius as per VM0048 guidelines.
2.  Concave Hull Application:
    -   Applied concaveman algorithm to ensure spatial concavity, accurately
        capturing the complex geometry of leakage belt edges.
3.  Leakage Belt Finalization:
    -   Calculated intersection of leakage buffer with the national boundary to
        define eligible leakage areas.

    -   Computed final area (ha) for monitoring purposes.

```{r, message=F, warning=F, error=F, comment=NA, eval=F}
aoi_union = sf::st_transform(aoi, 32629) |>  sf::st_union() |> sf::st_make_valid()
leakage_buffer = sf::st_buffer(aoi_union, dist = 5500, endCapStyle="ROUND") |>
  sf::st_as_sf()
leakage_buffer = concaveman::concaveman(leakage_buffer, concavity=5) |> 
  sf::st_zm() |> sf::st_make_valid()
leakage_belt_whole = sf::st_buffer(leakage_buffer, dist = 4500, endCapStyle="ROUND") |>
  sf::st_make_valid() 

tmap::tmap_mode("view")
tmap::tm_shape(leakage_belt_whole) + 
  tmap::tm_polygons(col="orange",fill="orange",fill_alpha=0.3,lwd=1)+
  #tmap::tm_add_legend(type="lines",col="orange",labels="Leakage Belt (10km)") +
  tmap::tm_shape(aoi) + tmap::tm_borders(lwd=1, col="white") +
  tmap::tm_basemap("Esri.WorldImagery")
```

```{r, echo=F, message=F, warning=F, error=F, comment=NA, eval=T}
# reload from local file to free up working memory
leakage_belt_whole   = sf::st_read("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/LEAKAGE/Archive/LeakageBelt_10k-Radius_UnFiltered-Whole.shp") 

tmap::tmap_mode("view")
tmap::tm_shape(leakage_belt_whole) + 
  tmap::tm_polygons(col="orange",fill="orange",fill_alpha=0.3,lwd=1)+
  #tmap::tm_add_legend(type="lines",col="orange",labels="Leakage Belt (10km)") +
  tmap::tm_shape(aoi) + tmap::tm_borders(lwd=1, col="white") +
  #tmap::tm_graticules(lines=T,labels.rot=c(0,90),lwd=0.2) +
  tmap::tm_scale_bar(position = c("RIGHT", "BOTTOM"), text.size = .5) + 
  tmap::tm_compass(color.dark = "gray60", text.color = "gray60", position = c("left", "top")) +
  tmap::tm_basemap("Esri.WorldImagery")
```

```{r, message=F, warning=F, error=F, comment=NA, eval=F}
leakage_belt    = sf::st_difference(leakage_belt_whole, st_union(st_combine(aoi_union)))
leakage_belt$area_ha = round(as.numeric(sf::st_area(leakage_belt) * 0.0001, 4)) 
leakage_belt = sf::st_intersection(country, leakage_belt)

tmap::tmap_mode("view")
tmap::tm_shape(leakage_belt) + 
  tmap::tm_polygons(col="yellow",fill="yellow",fill_alpha=0.3)+
  #tmap::tm_add_legend(type="lines",col="yellow",labels="Leakage Belt (10km)") +  
  tmap::tm_shape(aoi) + tmap::tm_borders(lwd=0.4, col="white") + 
  tmap::tm_text(text="Name", size=0.5, col="white") +
  tmap::tm_basemap("Esri.WorldImagery")

# save locally
#sf::wt_write(leakage_belt, "OneDrive.../20087 - RSPB Gola Feasibility/Deliverables/
#  Spatial Data/LEAKAGE/Archive/LeakageBelt_10k-Radius_UnFiltered.zip") 
#sf::st_write(leakage_belt_whole, "OneDrive.../20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/LEAKAGE/Archive/LeakageBelt_10k-Radius_UnFiltered-Whole.shp")
```

```{r, echo=F, message=F, warning=F, error=F, comment=NA, eval=T}
leakage_belt   = sf::st_read("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/LEAKAGE/Archive/LeakageBelt_10k-Radius_UnFiltered/leakage_belt_10km_liberia_ext.shp") 
leakage_belt$area_ha = round(as.numeric(sf::st_area(leakage_belt) * 0.0001, 4))
leakage_belt$Name = "Leakage Belt 10km Radius"
leakage_belt

tmap::tmap_mode("view")
tmap::tm_shape(leakage_belt) + 
  tmap::tm_polygons(col="yellow",fill="yellow",fill_alpha=0.3)+
  #tmap::tm_add_legend(type="lines",col="yellow",labels="Leakage Belt (10km)") +  
  tmap::tm_shape(aoi) + tmap::tm_borders(lwd=0.4, col="white") + 
  tmap::tm_text(text="Name", size=0.5, col="white") +
  #tmap::tm_graticules(lines=T,labels.rot=c(0,90),lwd=0.2) +
  tmap::tm_scale_bar(position = c("RIGHT", "BOTTOM"), text.size = .5) + 
  tmap::tm_compass(color.dark = "gray60", text.color = "gray60", position = c("left", "top")) +
  tmap::tm_basemap("Esri.WorldImagery")
```

### Derive Leakage Masks

#### Roads Mask

Following leakage belt exclusion criteria outlined in VMD0055, we removed areas
that were located within 10km of road infrastructure. This was implemented to
reduce false-positive leakage signals.

*Implementation steps:*

1.  Road Data Processing:
    -   Imported and validated two road datasets and checked for geometry errors
        or merging issues.
    -   The Douglas-Peucker algorithm[^4] was employed on larger datasets to
        reduce computational load by simplifying vertex networks, while
        maintaining structural and linework integrity.
2.  Buffering roads:
    -   Created 10 km buffer around roads with simplified geometries to produce
        a leakage exclusion mask.
    -   Unified separate buffers into a single comprehensive road mask for
        spatial consistency.

[^4]: Douglas, D. H., & Peucker, T. K. (1973). Algorithms for the reduction of
    the number of points required to represent a digitized line or its
    caricature. *Cartographica: the international journal for geographic
    information and geovisualization*, *10*(2), 112-122.

```{r, message=F, warning=F, error=F, comment=NA, eval=F}
roads_ext = sf::st_read("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/ROADS/Archive/Roads_Gola_RSPB-OSM-Combined/Roads_Gola_RSPB-OSM-Merged.shp") |> 
  sf::st_make_valid() |> sf::st_cast("MULTILINESTRING") |> rmapshaper::ms_simplify(keep=0.5)
roads_one = sf::st_read("~/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/ROADS/Archive/roads_simplified_one.shp")
roads_two = sf::st_read("~/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/ROADS/Archive/roads_simplified_two.shp")

# we have simplify mask shapefiles and split them up to shorten computing 
# time & avoid crashing. See option for "harsh" simplification on line 163
roads_one_simplified = roads_one |> sf::st_make_valid() |> sf::st_cast("MULTILINESTRING") |> 
  rmapshaper::ms_simplify(keep=0.5)
roads_two_simplified = roads_two |> sf::st_make_valid() |> sf::st_cast("MULTILINESTRING") |> 
  rmapshaper::ms_simplify(keep=0.5)

# bigger file needs more simplificaiotn
roads_one_simplified_harsh = rmapshaper::ms_simplify(
  roads_one_simplified, keep=0.01) 

# now apply buffer operation, but note this takes time. Its 
# advised processing inputs as much as possible before running
roads_one_buffer = sf::st_buffer(
  roads_one_simplified_harsh, 
  dist = 10000, 
  nQuadSegs = 5,
  endCapStyle="ROUND", 
  joinStyle = "ROUND",
  mitreLimit = 1,
  singleSide = FALSE
  )

roads_two_buffer = sf::st_buffer(
  roads_two_simplified, 
  dist = 10000, 
  nQuadSegs = 5,
  endCapStyle="ROUND", 
  joinStyle = "ROUND",
  mitreLimit = 1,
  singleSide = FALSE
  )

# Combine, dissolve and cast to single feature
roads_mask = sf::st_combine(roads_one_buffer, roads_two_buffer) |>
  sf::st_union() |> sf::st_cast("POLYGON")

# Visual check
tmap::tmap_mode("view")
tmap::tm_shape(roads_mask) + tmap::tm_borders(lwd=0) +
  tmap::tm_shape(roads_one_simplified_harsh) + tmap::tm_lines(lwd=2, col="red") +
  tmap::tm_shape(roads_two_simplified) + tmap::tm_lines(lwd=2, col="green") +
  tmap::tm_shape(roads_mask) + tmap::tm_borders(lwd=1, col="pink") + 
  #tmap::tm_graticules(lines=T,labels.rot=c(0,90),lwd=0.2) +
  tmap::tm_scale_bar(position = c("RIGHT", "BOTTOM"), text.size = .5) + 
  tmap::tm_compass(color.dark = "gray60", text.color = "gray60", position = c("left", "top")) +
  tmap::tm_basemap("Esri.WorldImagery")


# Save output to MASKS folder and purge memory
#sf::st_write(roads_mask, "/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/MASKS/LeakageMask_Roads_10km-Buffer_051625.shp", delete_dsn=T)
```

```{r, echo=F}
roads_one = sf::st_read("~/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/ROADS/Archive/roads_simplified_one.shp")
roads_two = sf::st_read("~/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/ROADS/Archive/roads_simplified_two.shp")
roads_mask = sf::st_read("~/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/MASK/Archive/LeakageMask_Roads_10km-Buffer_051625/Road_Mask_10km-Proximity_051625.shp")# |> sf::st_transform(3857) 
roads_ext = sf::st_read("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/ROADS/Archive/Roads_Gola_RSPB-OSM-Combined/Roads_Gola_RSPB-OSM-Merged.shp") |> 
  sf::st_make_valid() |> sf::st_cast("MULTILINESTRING") |> rmapshaper::ms_simplify(keep=0.5)

# we have simplify mask shapefiles and split them up to shorten computing 
# time & avoid crashing. See option for "harsh" simplification on line 163
roads_one_simplified = roads_one |> sf::st_make_valid() |> sf::st_cast("MULTILINESTRING") |> 
  rmapshaper::ms_simplify(keep=0.5)# |> sf::st_transform(3857)
roads_two_simplified = roads_two |> sf::st_make_valid() |> sf::st_cast("MULTILINESTRING") |> 
  rmapshaper::ms_simplify(keep=0.5)# |> sf::st_transform(3857)

# bigger file needs more simplificaiotn
roads_one_simplified_harsh = rmapshaper::ms_simplify(
  roads_one_simplified, keep=0.01) 

# Visual check
tmap::tmap_mode("view")
tmap::tm_shape(roads_mask) + tmap::tm_borders(lwd=0) +
  tmap::tm_shape(roads_one_simplified_harsh) + tmap::tm_lines(lwd=2, col="red") +
  tmap::tm_shape(roads_two_simplified) + tmap::tm_lines(lwd=2, col="green") +
  tmap::tm_shape(roads_mask) + tmap::tm_borders(lwd=1, col="pink") + 
  #tmap::tm_graticules(lines=T,labels.rot=c(0,90),lwd=0.2) +
  tmap::tm_scale_bar(position = c("RIGHT", "BOTTOM"), text.size = .5) + 
  tmap::tm_compass(color.dark = "gray60", text.color = "gray60", position = c("left", "top")) +
  tmap::tm_basemap("Esri.WorldImagery")
```

#### Habitat Masks

Habitat masks were derived using wetlands and protected area datasets confirmed
through discussions with the client. Both VM0048 and VMD0055 guidelines
explicitly stipulate the exclusion of certain land categories from leakage belts
to ensure accurate and conservative leakage monitoring. As highlighted during
design meetings in March, Verra has provided additional guidance to project
developers wishing to confirm the legal definitions of these area designations.
While high variance and inconsistency is typical of spatial datasets
representing wetlands, conservation habitats, artisanal farming and rural road
networks in forested landscapes, Verra has also acknowledged that such mapping
criteria particularly related to proected areas is likely to require
considerable discussions and negotiations with local stakeholders, national
government, and with Verra's VM0048 committee.

*Implementation steps:*

1.  Wetlands data processing:
    -   Imported wetland raster datasets from peer-reviewed and approved sources
        as mandated by VMD0055.

    -   Cropped wetlands raster precisely to the spatial extent of the
        identified leakage belt.

    -   Reclassified wetland habitat classes based explicitly on VM0048
        criteria, distinguishing eligible classes clearly, adhering to
        procedures outlined in Appendix 2 of VMD0055.
2.  Wetland mask generation:
    -   Converted classified wetlands into a binary mask layer, ensuring
        compatibility and direct alignment with VM0048/VMD0055 requirements to
        exclude wetlands from leakage areas.

```{r, eval=T, error=F}
# Prepare shell for cropping 
leakage_belt_crop = sf::st_transform(sf::st_as_sf(leakage_belt_whole), 32629) |> terra::vect()

# import inputs, and simplify
waterways = sf::st_read("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/HYDRO/Waterways/Winrock_Waterways_Gola_051625.gpkg") |> 
  sf::st_make_valid() |> 
  sf::st_cast("MULTILINESTRING") 

wetlands  = terra::rast("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/HABITAT/Wetlands/GLWD_EPSG32629.tif")
wetlands          = terra::crop(wetlands, leakage_belt_crop, mask=T)

# tidy labeling
code_dict_2 <- data.frame(
  id = c(1, 4, 7, 10, 12, 14, 15, 18, 20, 21, 26, 31),
  label = c(
    "Freshwater lake",                              # 1
    "Large river",                                  # 4
    "Small streams",                                # 7
    "Riverine, regularly flooded, forested",        # 10
    "Riverine, seasonally flooded, forested",       # 12
    "Riverine, seasonally saturated, forested",     # 14
    "Riverine, seasonally saturated, non-forested", # 15
    "Palustrine, seasonally saturated, forested",   # 18
    "Ephemeral, forested",                          # 20
    "Ephemeral, non-forested",                      # 21
    "Tropical peatland, forested",                  # 26
    "Other coastal wetland"                         # 31
  ))

levels(wetlands) <- code_dict_2
wetlands[wetlands == 0] <- NA

# derive wetland mask
wetlands_mask <- wetlands
wetland_classes <- c(1, 4, 7, 10, 12, 14, 15, 18, 20, 21, 26, 31)
terra::values(wetlands_mask) <- ifelse(terra::values(wetlands) %in% wetland_classes, 1, NA)

tmap::tmap_mode("view")
tmap::tm_shape(leakage_belt_whole) + tmap::tm_borders(lwd=0) +
  tmap::tm_shape(leakage_belt)+tmap::tm_polygons(col="yellow",fill="yellow",fill_alpha=0.4,lwd=1.5) + 
  tmap::tm_shape(wetlands) + tmap::tm_raster(col.legend = tm_legend("Wetlands (GLWD")) +
  tmap::tm_shape(aoi) + tmap::tm_borders(lwd=1, col="red") + 
  tmap::tm_text(text="Name", size=0.3, col="black") +
  tmap::tm_scalebar(position = c("RIGHT", "BOTTOM"), text.size = .5) + 
  tmap::tm_compass(color.dark = "gray60", text.color = "gray60", position = c("left", "top")) +
  tmap::tm_basemap("Esri.WorldImagery")
```

*Implementation steps:*

1.  Protected areas mask:
    -   Obtained spatial datasets from the World Database on Protected Areas
        (WDPA),[^5] ensuring compliance with Verra's approved data sources.

    -   Conducted spatial overlay analysis to identify and exclude legally
        protected areas classified under IUCN categories I, II, and III,
        existing managed timber concessions, and UDef PAs and UDef LBs
        previously validated or verified within the past five years, as
        stipulated by VMD0055 Appendix 2.

    -   Ensured all data underwent verification of legal status and eligibility
        through consultation with local stakeholders and Liberian regulatory
        authorities, following VMD0055 standards.
2.  Legal and Compliance Considerations:
    -   All data inputs were verified against regulatory standards, ensuring
        legality and eligibility for inclusion/exclusion from the leakage belt.

    -   Initial analyses deliberately excluded protected lands pending further
        verification of conservation areas' legal statuses with stakeholders,
        regulatory bodies, and Verra, in accordance with VMD0055 guidelines.

    -   Documentation of all masking operations and criteria applied was
        systematically recorded for transparency, validation, and future
        auditing processes, explicitly aligning with VM0048 (Sections 8.3) and
        VMD0055 (Section 5.1.3-5.2; Appendix 2).

[^5]: <https://developers.google.com/earth-engine/datasets/catalog/WCMC_WDPA_current_polygons>

```{r, eval=T, error=F}
protected_areas = sf::st_read("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/HABITAT/Protected Areas/Archive/WDPA_Mar2025_Public_32629_GOLA.shp")
#protected_areas = terra::crop(protected_areas, leakage_belt_crop, mask=T)

tmap::tmap_mode("view")
tmap::tm_shape(leakage_belt_whole) + tmap::tm_borders(lwd=0) +
  tmap::tm_shape(leakage_belt) + tmap::tm_polygons(col="yellow",fill="yellow",fill_alpha=0.4, lwd=1)+ 
  tmap::tm_shape(protected_areas) + tmap::tm_polygons(fill="ORIG_NAME", fill.legend = tm_legend("Protected Areas (WDPA)")) +
  tmap::tm_shape(aoi) + tmap::tm_borders(lwd=1, col="red") + 
  tmap::tm_text(text="Name", size=0.5, col="grey") +
  tmap::tm_scalebar(position = c("RIGHT", "BOTTOM"), text.size = .5) + 
  tmap::tm_compass(color.dark = "gray60", text.color = "gray60", position = c("left", "top")) +
  tmap::tm_basemap("Esri.WorldImagery")

```

#### Slope Mask

*Implementation steps:*

Slope masking operations are performed to comply explicitly with VM0048 and
VMD0055 standards, which require excluding areas exceeding a slope gradient of
10% from leakage belt delineation to prevent erroneous leakage attribution.

1.  Slope data acquisition:
    -   Utilized Digital Elevation Model (DEM) data sourced from HydroSHEDS
        (V2),[^6] which is derived primarily from Shuttle Radar Topography
        Mission (SRTM) elevation models, including products that are conditioned
        with void-filling, stream burning, filtering, and manual corrections to
        ensure hydrological integrity and accuracy. This source is recognized
        and approved by Verra as a credible data source for hydrological
        analyses and leakage delineations. Higher resolution DEMs with similar
        gold standard processing are also available in the ESA Copernicus
        collection (25m resolution) and many more. Best warehouse for publicly
        available and transparent methodological reporting can be found through
        OpenTopography platform.[^7]
2.  Slope processing:
    -   Calculated slope gradients from the DEM in degrees, subsequently
        converting these values into percent slope.
    -   Identified and classified areas with slope gradients greater than 10%,
        (\> not \>=) marking them explicitly for exclusion based on criteria
        detailed in VM0048 (Section 8.3) and VMD0055 (Section 5.1.3, Appendix
        2).
3.  Slope mask generation:
    -   Transformed high-gradient areas identified as invalid (\>10% slope) into
        polygon geometries, performing subsequent geoprocessing operations to
        dissolve and simplify these features, ensuring computational efficiency
        without compromising compliance with VMD0055 standards.
4.  Justifying VM0048-compliance:
    -   Documented HydroSHEDS source information, citing technical documentation
        explicitly regarding processing steps and geometric corrections as
        mandated by VM0048 and VMD0055 methodologies.
    -   Maintained records of slope calculations workflows, mask generation
        processes to provide transparency, facilitate third-party verification
        through replication.

[^6]:
    -   <https://agupubs.onlinelibrary.wiley.com/doi/10.1029/2008EO100001>
    -   <https://data.hydrosheds.org/file/technical-documentation/HydroSHEDS_TechDoc_v1_4.pdf>

[^7]: <https://portal.opentopography.org/datasets>

```{r, error=F, eval=F}
# skipping these operations here (est. time 12 mins)
DEM = terra::rast("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/DEM/DEM_EPSG32629.tif") 

# derive slope percentage from degree 
slope_degrees = terra::terrain(DEM, v="slope", unit="degrees")
slope_percent = tan(slope_degrees * (pi / 180)) * 100
slope_percent = terra::clamp(slope_percent, 0, 100) 
slope_invalid = slope_percent > 10
slope_invalid[slope_invalid == 0] <- NA
slope_mask = terra::as.polygons(slope_invalid, dissolve=T)|>sf::st_as_sf()|>sf::st_union()

# save locally & reload to purge cache
sf::st_write(slope_mask, "/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/MASK/LeakageMask_Slope10%-Invalid_051625.zip", delete_dsn=T)
slope_mask = sf::st_read("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/MASK/Archive/LeakageMask_Slope10%-Invalid_051625/slope_poly_simplified.shp")

tmap::tm_shape(leakage_belt) + tmap::tm_polygons(col="yellow",fill="yellow",fill_alpha=0.4, lwd=1.5)+ 
  tmap::tm_shape(aoi) + tmap::tm_borders(lwd=1.5, col="red") + 
  tmap::tm_text(text="Name", size=0.3, col="white") +
  tmap::tm_shape(slope_mask) + tmap::tm_polygons(fill="purple", fill_alpha=0.6, lwd=0)+ 
  tmap::tm_scalebar(position = c("RIGHT", "BOTTOM"), text.size = .5) + 
  tmap::tm_compass(color.dark = "gray60", text.color = "gray60", position = c("left", "top")) +
  tmap::tm_basemap("Esri.WorldImagery")

```

```{r, echo=F, eval=T}
#slope polyon is too large so reverted to raster mask for mapping
#slope_mask = sf::st_read("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/MASK/Archive/LeakageMask_Slope10%-Invalid_051625/slope_poly_simplified.shp") |> sf::st_make_valid() |> sf::st_cast("POLYGON") |> rmapshaper::ms_simplify(keep=0.1)

slope_mask = terra::rast("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/MASK/LeakageMask_Slope10%-Raster_051625.tif")
slope_mask[slope_mask == 0] <- NA
#slope_mask_factor <- as.factor(slope_mask)
levels(slope_mask) <- data.frame(ID = 1,label = "Slope Exclusion Zone")

tmap::tm_shape(leakage_belt) + tmap::tm_polygons(col="yellow",fill="yellow",fill_alpha=0, lwd=1)+ 
  tmap::tm_shape(aoi) + tmap::tm_borders(lwd=1, col="red") + 
  tmap::tm_text(text="Name", size=0.5, col="white") +
  tmap::tm_shape(slope_mask) + 
  tmap::tm_raster(title = "", palette = "purple", alpha=0.35, labels="Slope Exclusion Zone") +
  tmap::tm_scalebar(position = c("RIGHT", "BOTTOM"), text.size = .5) + 
  tmap::tm_compass(color.dark = "gray60", text.color = "gray60", position = c("left", "top")) +
  tmap::tm_basemap("Esri.WorldImagery")
```

#### Visual review

The static maps provided in the word report of this output confirm the
individual mask layers and their rough distribution, but the useful insight
comes from examining all layers together using the interactive `tmap` viewer
below. This allows you to explore at different scales all qualifying layers of
roads, wetlands, protected areas, slope, atop of the project's boundaries,
physical features, demographic data, and the leakage area belt to explore
specific overlaps.

*Guide:*

1.  Toggle layers in the left‑hand overlay panel to isolate specific criteria.
    For example, you may switch off wetlands to focus on roads and slope.

2.  Zoom and pan to evaluate local‐scale edge effects, particularly around
    settlement clusters and county boundaries where multiple exclusions overlap.

3.  Inspect features: hovering over polygons reveals attribute names and areas
    so you can verify that features have been correctly classified and clipped.

```{r}
# Visual check
tmap::tmap_mode("view")
tmap::tm_shape(leakage_belt_whole) + tmap::tm_borders(lwd=0) +
  tmap::tm_shape(country) + tmap::tm_borders(lwd=1.5, col="grey30") + 
  tmap::tm_shape(counties) + tmap::tm_borders(lwd=0.5, col="grey70") + 
  tmap::tm_shape(leakage_belt) + tmap::tm_polygons(col="yellow",fill="yellow",fill_alpha=0.4, lwd=1)+ 
  tmap::tm_shape(wetlands) + tmap::tm_raster(col.legend = tm_legend("Wetlands (GLWD")) +
  tmap::tm_shape(waterways) + tmap::tm_lines(lwd="ORD_STRA", lwd.scale=tm_scale_asis(values.scale=0.4),col="skyblue")+ 
  tmap::tm_shape(protected_areas) + tmap::tm_polygons(fill="ORIG_NAME",fill.legend=tm_legend("Protected Areas (WDPA)"))+
  tmap::tm_shape(slope_mask) + tmap::tm_raster(title="", palette="purple", labels="Slope Exclusion Zone") +
  tmap::tm_shape(roads_mask) + tmap::tm_borders(col="green", lwd=1.5) +
  tmap::tm_shape(roads_ext) +tmap::tm_lines(col="Category",   col.legend=tm_legend("Road network")) +
  tmap::tm_shape(aoi) + tmap::tm_borders(lwd=1, col="red") + 
  tmap::tm_text(text="Name", size=0.5, col="beige") +
  tmap::tm_shape(pop) + tm_symbols(size=0.4, col = "pink", id="name", popup.vars = TRUE) +
  tmap::tm_add_legend(type="symbols", col="pink", size=1, labels="Settlments") +
    tmap::tm_basemap("Esri.WorldImagery")

```

```{r, echo=F, eval=F}
slope_mask = sf::st_read("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/MASK/Archive/LeakageMask_Slope10%-Invalid_051625/slope_poly_simplified.shp")
wetlands = terra::rast("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/HABITAT/Wetlands/GLWD_EPSG32629.tif")
protected_areas = sf::st_read("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/HABITAT/Protected Areas/Archive/WDPA_Mar2025_Public_32629_GOLA.shp")

# Visual check
tmap::tmap_mode("view")
#tmap::tm_basemap("OpenStreetMap") +
tmap::tm_shape(roads_mask) + tmap::tm_borders(lwd=0) +
  tmap::tm_shape(wetlands) + tmap::tm_raster(col.legend = tm_legend("Wetlands (GLWD")) +
  tmap::tm_shape(leakage_belt) + tmap::tm_polygons(col="yellow",fill="yellow",fill_alpha=0.4, lwd=1.5)+ 
  tmap::tm_shape(protected_areas) + tmap::tm_polygons(fill="ORIG_NAME", fill.legend = tm_legend("Protected Areas (WDPA)")) +
  tmap::tm_shape(aoi) + tmap::tm_borders(lwd=1.5, col="red") + 
  tmap::tm_text(text="Name", size=0.3, col="black") +
  tmap::tm_shape(roads_mask) + tmap::tm_borders(col="purple") +
  tmap::tm_scalebar(position = c("RIGHT", "BOTTOM"), text.size = .5) + 
  tmap::tm_compass(color.dark = "gray60", text.color = "gray60", position = c("left", "top"))

# slope filter is large file with dense linework that 
# needs seperate mapping to visualize and slower rendering
tmap::tm_shape(slope_mask) + tmap::tm_borders(col="purple") +
  tmap::tm_shape(leakage_belt)) + tmap::tm_polygons(col="yellow",fill="yellow",fill_alpha=0.3)+ 
  tmap::tm_shape(aoi) + tmap::tm_borders(lwd=0.2, col="white") + 
  tmap::tm_text(text="Name", size=0.4, col="white") +
  tmap::tm_scale_bar(position = c("RIGHT", "BOTTOM"), text.size = .5) + 
  tmap::tm_compass(color.dark = "gray60", text.color = "gray60", position = c("left", "top"))
```

### Apply Leakage Masks

*Implementation steps:*

1.  Mask Intersection:
    -   Apply intersection or clipping functions between the larger unfiltered
        leakage belt and the four generated masks representation invalid
        exclusion zones according to criteria relating to roads, slope,
        wetlands, protected areas.
2.  Mask documentation:
    -   Document and store results for transparency and audit readiness. Without
        clear documentation or SOPs, an auditors' replication becomes arduous
        and cryptic instead of transparent and reassuring, creating more of a
        problem with growing concerns of related data and analyses.
    -   Saved the final, “filtered” leakage belt shapefile (e.g.,
        `LeakageBelt_10km_051625.shp`).

```{r, error=F, eval=F}
# clip
roads_leakage           = sf::st_intersection(leakage_belt, roads_mask)
slope_leakage           = sf::st_difference(leakage_belt, slope_mask)
wetlands_leakage        = sf::st_difference(leakage_belt, wetlands_mask)
protected_areas_leakage = sf::st_difference(leakage_belt, protected_areas)

# It may make better sense to derive and apply these seperately for faster processing
leakage_area_a     = sf::st_union(roads_leakage, slope_leakage)
leakage_area_b     = sf::st_union(leakage_area_a, wetlands_leakage)
leakage_area_valid = sf::st_union(leakage_area_b, protected_areas_leakage)

# save ouput before it crashes
sf::st_write(leakage_area_valid, "/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/LEAKAGE/Archive/LeakageBelt_10km_051625/LeakageBelt_10k-Radius_Filtered-WDPA_GLWD_SLOPE-10PC_ROADS-10KM.shp", delete_dsn=T)

# Visualise
tmap::tmap_mode("view")
tmap::tm_shape(leakage_belt_valid) + tmap::tm_polygons(col="yellow",fill="yellow",fill_alpha=1, lwd=0) + 
  tmap::tm_shape(country) + tmap::tm_borders(lwd=1.5, col="grey30") + 
  tmap::tm_shape(counties) + tmap::tm_borders(lwd=0.5, col="grey70") + 
  tmap::tm_shape(aoi) + tmap::tm_borders(lwd=0.5, col="red") + 
  tmap::tm_basemap("Esri.WorldImagery")
```

```{r, echo=FALSE}
leakage_belt_valid = sf::st_read("/Users/seamus/Library/CloudStorage/OneDrive-WinrockInternationalInstituteforAgriculturalDevelopment/20087 - RSPB Gola Feasibility/Deliverables/Spatial Data/LEAKAGE/Archive/LeakageBelt_10km_051625/LeakageBelt_10k-Radius_Filtered-WDPA_GLWD_SLOPE-10PC_ROADS-10KM.shp") |> sf::st_make_valid() |> sf::st_cast()
leakage_belt_valid$area_ha = round(as.numeric(sf::st_area(leakage_belt_valid) * 0.0001, 4))
leakage_belt_valid$area_ha

# Visualise
tmap::tmap_mode("view")
tmap::tm_shape(leakage_belt_valid) + tmap::tm_polygons(col="yellow",fill="yellow",fill_alpha=1, lwd=0) + 
  tmap::tm_shape(country) + tmap::tm_borders(lwd=1.5, col="grey30") + 
  tmap::tm_shape(counties) + tmap::tm_borders(lwd=0.5, col="grey70") + 
  tmap::tm_shape(aoi) + tmap::tm_borders(lwd=0.5, col="red") + 
  tmap::tm_basemap("Esri.WorldImagery")
```

### Tally Leakage Area Features

*Implementation steps:*

1.  **Intersection**
    -   Intersected valid leakage area zones with spatial locations of roads,
        resdential communities, and waterways to count and sum the lengths of
        physical features considered significant deforestation drivers. These
        quantitative estimates and their supporting mapping should inform the
        targeted development of the project's monitoring plan, as required by
        VM0048.
2.  **Relevance**
    -   These outputs support project proponents to see how many communities
        might be subject to shifted deforestation or potential engagement for
        leakage mitigation.
    -   Facilitates targeted interventions and resource mobilizaiton around
        agricultural intensification and alternative livelihood development near
        these population centers rthat are most at risk of displacement. For
        example, we estimated the following estimates from inside the project's
        new leakage area belt:
        -   1,235.5km of waterways,
        -   2,135.5km of road network,
        -   Total valid leakage area within a 10km radius of the project:
            **118,109 ha**

```{r, message=F, warning=F, error=F, comment=NA, eval=F}
waterways_count_whole = sf::st_intersection(waterways, sf::st_as_sf(leakage_belt_crop))
waterways_count_valid = sf::st_intersection(waterways, leakage_belt)
waterways_length_whole = sum(sf::st_length(waterways_count_whole))
waterways_length_valid = sum(sf::st_length(waterways_count_valid))

road_count_whole = sf::st_intersection(roads_ext, sf::st_as_sf(leakage_belt_crop))
road_count_valid = sf::st_intersection(roads_ext, leakage_belt)
road_length_whole = sum(sf::st_length(road_count_whole)) + sum(sf::st_length(road_count_whole))
road_length_valid = sum(sf::st_length(road_count_valid)) + sum(sf::st_length(road_count_valid))

community_count_whole = sf::st_intersection(pop, sf::st_as_sf(leakage_belt_crop))
community_count_valid = sf::st_intersection(pop, leakage_belt)

waterways_length_whole
waterways_length_valid
road_length_whole
road_length_valid
community_count_whole
community_count_valid
```

```{r, class.source = c("numCode", "r", "numberLines")}
devtools::session_info()
#Sys.getenv()
#.libPaths()
```
